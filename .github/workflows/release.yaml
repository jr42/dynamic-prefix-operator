name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write

env:
  REGISTRY: ghcr.io

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Get version from tag
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Update Chart version
        run: |
          sed -i "s/^version:.*/version: ${{ steps.version.outputs.version }}/" charts/dynamic-prefix-operator/Chart.yaml
          sed -i "s/^appVersion:.*/appVersion: \"${{ steps.version.outputs.version }}\"/" charts/dynamic-prefix-operator/Chart.yaml
          # Update image tag to use the release version
          sed -i "s/tag:.*/tag: \"v${{ steps.version.outputs.version }}\"/" charts/dynamic-prefix-operator/values.yaml

      - name: Generate install.yaml
        run: |
          # Install kustomize
          go install sigs.k8s.io/kustomize/kustomize/v5@latest

          # Update image in kustomize
          cd config/manager
          $(go env GOPATH)/bin/kustomize edit set image controller=${{ env.REGISTRY }}/${{ github.repository }}:v${{ steps.version.outputs.version }}
          cd ../..

          # Build the full manifest
          $(go env GOPATH)/bin/kustomize build config/default > install.yaml

      - name: Package Helm chart
        run: |
          helm package charts/dynamic-prefix-operator --destination .

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Push Helm chart to OCI registry
        run: |
          helm push dynamic-prefix-operator-${{ steps.version.outputs.version }}.tgz oci://${{ env.REGISTRY }}/${{ github.repository_owner }}/dynamic-prefix-operator/helm

      - name: Generate release notes
        id: notes
        run: |
          cat << 'EOF' > release-notes.md
          ## Installation

          ### Using Helm (recommended)

          ```bash
          helm install dynamic-prefix-operator \
            oci://ghcr.io/${{ github.repository_owner }}/dynamic-prefix-operator/helm/dynamic-prefix-operator \
            --version ${{ steps.version.outputs.version }}
          ```

          ### Using kubectl

          ```bash
          kubectl apply -f https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/install.yaml
          ```

          ## Docker Images

          Multi-arch images (amd64, arm64) are available at:

          ```
          ghcr.io/${{ github.repository }}:v${{ steps.version.outputs.version }}
          ```

          ## What's Changed

          See the [commit history](https://github.com/${{ github.repository }}/commits/v${{ steps.version.outputs.version }}) for details.
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body_path: release-notes.md
          files: |
            install.yaml
            dynamic-prefix-operator-${{ steps.version.outputs.version }}.tgz
          fail_on_unmatched_files: true
