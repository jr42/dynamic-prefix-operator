# Example: Deutsche Telekom Home Connection
# This example shows a typical German residential IPv6 setup where
# the ISP provides a /56 prefix that changes periodically.
---
apiVersion: network.reith.cloud/v1alpha1
kind: DynamicPrefix
metadata:
  name: deutsche-telekom-ipv6
spec:
  # How to acquire the prefix
  acquisition:
    # Primary: DHCPv6 Prefix Delegation
    # The operator acts as a DHCPv6 client to request a prefix from the ISP
    dhcpv6:
      # Network interface connected to the ISP (often a VLAN)
      interface: enp1s0.222

      # Request a /60 from the ISP's /56
      # This gives us 16 /64 subnets to work with
      requestedPrefixLength: 60

      # DUID (DHCP Unique Identifier) for consistent identity
      # "auto" generates based on hardware, or specify explicitly
      duid: auto

    # Fallback: Router Advertisement monitoring
    # Used when DHCPv6-PD isn't available or for validation
    routerAdvertisement:
      interface: enp1s0.222
      enabled: true

  # Subnet allocation from the acquired prefix
  # Example: If we get 2001:db8:1234:ab00::/60
  subnets:
    # LoadBalancer IPs for external services
    # 2001:db8:1234:ab00::1000/120 = 256 addresses
    - name: loadbalancers
      offset: 0x1000
      prefixLength: 120

    # Service ClusterIPs (if using IPv6 for cluster)
    # 2001:db8:1234:ab00::2000/112 = 65536 addresses
    - name: services
      offset: 0x2000
      prefixLength: 112

    # Pod network (if assigning global IPv6 to pods)
    # 2001:db8:1234:ab01::/64 = entire /64 subnet
    - name: pods
      offset: 0x10000  # Next /64 in our /60
      prefixLength: 64

  # Graceful transition settings
  # When the ISP changes our prefix, don't immediately break things
  transition:
    # Keep old prefix active for 60 minutes
    # This allows:
    # - DNS TTLs to expire (typically 300s)
    # - Active connections to complete
    # - external-dns to update records
    drainPeriodMinutes: 60

    # Keep last 2 prefixes in history for debugging
    maxPrefixHistory: 2

---
# Simpler example for testing or static prefix
apiVersion: network.reith.cloud/v1alpha1
kind: DynamicPrefix
metadata:
  name: test-static-prefix
spec:
  acquisition:
    # Only use RA monitoring (no DHCPv6-PD)
    routerAdvertisement:
      interface: eth0
      enabled: true

  subnets:
    - name: default
      offset: 0
      prefixLength: 120

  transition:
    drainPeriodMinutes: 5
    maxPrefixHistory: 1
