# Example: Home/SOHO IPv6 Setup
# The operator receives a delegated prefix from your upstream router
# and keeps Kubernetes resources in sync when it changes.
---
apiVersion: dynamic-prefix.io/v1alpha1
kind: DynamicPrefix
metadata:
  name: home-ipv6
spec:
  # How to receive the delegated prefix
  acquisition:
    # Primary: Receive via DHCPv6 Prefix Delegation
    # The operator acts as a DHCPv6-PD client on this interface
    dhcpv6pd:
      # Interface connected to upstream router that delegates prefixes
      interface: eth0

      # Hint for requested prefix length (optional)
      # If your ISP gives you a /56, you might request a /60 for this use
      requestedPrefixLength: 60

    # Fallback: Monitor Router Advertisements
    # Used when DHCPv6-PD isn't available or for validation
    routerAdvertisement:
      interface: eth0
      enabled: true

  # Subnet allocation from the received prefix
  # Example: If we receive 2001:db8:1234:ab00::/60
  subnets:
    # LoadBalancer IPs for external services
    # 2001:db8:1234:ab00::1000/120 = 256 addresses
    - name: loadbalancers
      offset: 0x1000
      prefixLength: 120

    # DMZ services
    # 2001:db8:1234:ab00::2000/112 = 65536 addresses
    - name: dmz
      offset: 0x2000
      prefixLength: 112

    # Network policy matching (entire received prefix)
    - name: all
      offset: 0
      prefixLength: 60  # Same as received prefix

  # Graceful transition settings
  transition:
    # Keep old prefix active for 60 minutes during transitions
    # This allows:
    # - DNS TTLs to expire (typically 300s)
    # - Active connections to complete
    # - external-dns to update records
    drainPeriodMinutes: 60

    # Keep last 2 prefixes in history for debugging
    maxPrefixHistory: 2

---
# Simpler example for testing or RA-only networks
apiVersion: dynamic-prefix.io/v1alpha1
kind: DynamicPrefix
metadata:
  name: simple-ipv6
spec:
  acquisition:
    # Only use RA monitoring (no DHCPv6-PD)
    routerAdvertisement:
      interface: eth0
      enabled: true

  subnets:
    - name: default
      offset: 0
      prefixLength: 120

  transition:
    drainPeriodMinutes: 5
    maxPrefixHistory: 1

---
# Example: VLAN interface
apiVersion: dynamic-prefix.io/v1alpha1
kind: DynamicPrefix
metadata:
  name: vlan222-ipv6
spec:
  acquisition:
    dhcpv6pd:
      # VLAN interface for DMZ network
      interface: enp1s0.222
      requestedPrefixLength: 64

  subnets:
    - name: services
      offset: 0x100
      prefixLength: 120
