# =============================================================================
# Mode 1: Address Range (Recommended for Home/SOHO)
# =============================================================================
# Reserve a range within your existing /64 that won't conflict with SLAAC/DHCPv6.
# Simple setup, no BGP required. Works with any router.
#
# Requirements:
# 1. Configure your router to exclude this range from DHCPv6/SLAAC
# 2. The operator passively monitors RAs to detect prefix changes

---
apiVersion: dynamic-prefix.io/v1alpha1
kind: DynamicPrefix
metadata:
  name: home-ipv6
  labels:
    app.kubernetes.io/name: dynamic-prefix-operator
spec:
  acquisition:
    # Passive RA monitoring - safe, won't conflict with existing DHCP clients
    routerAdvertisement:
      interface: eth0
      enabled: true

  # Address ranges within the /64 (Mode 1)
  # These define reserved ranges that your router is configured to leave unused
  addressRanges:
    # Reserve the last 4096 addresses (::f000:0:0:0 to ::ffff:ffff:ffff:ffff)
    # Example: If prefix is 2001:db8:abcd:1::/64
    #   Range: 2001:db8:abcd:1:f000:: to 2001:db8:abcd:1:ffff:ffff:ffff:ffff
    - name: loadbalancers
      start: "::f000:0:0:0"
      end: "::ffff:ffff:ffff:ffff"

  transition:
    drainPeriodMinutes: 60
    maxPrefixHistory: 2

---
# Mode 1 with multiple address ranges
apiVersion: dynamic-prefix.io/v1alpha1
kind: DynamicPrefix
metadata:
  name: multi-range
spec:
  acquisition:
    routerAdvertisement:
      interface: eth0
      enabled: true

  addressRanges:
    # LoadBalancer pool (256 addresses)
    - name: lb-pool
      start: "::f000:0:0:0"
      end: "::f0ff:0:0:0"

    # MetalLB speaker pool (256 addresses)
    - name: metallb
      start: "::f100:0:0:0"
      end: "::f1ff:0:0:0"

    # Egress gateway pool (16 addresses)
    - name: egress
      start: "::ff00:0:0:0"
      end: "::ff0f:0:0:0"

  transition:
    drainPeriodMinutes: 30
    maxPrefixHistory: 2

---
# =============================================================================
# Mode 2: Dedicated Subnet (Advanced, requires BGP)
# =============================================================================
# Carve out a dedicated /64 from a larger prefix (e.g., /56 from ISP).
# Requires BGP to announce the subnet to your router.
#
# Use this when:
# - You need strict address separation
# - You have more than a /64 from your ISP
# - You're comfortable with BGP

---
apiVersion: dynamic-prefix.io/v1alpha1
kind: DynamicPrefix
metadata:
  name: advanced-ipv6
spec:
  acquisition:
    # DHCPv6-PD to request a larger prefix from upstream
    # WARNING: May conflict with existing DHCP clients on the interface
    dhcpv6pd:
      interface: eth0
      requestedPrefixLength: 56

    # RA fallback for validation
    routerAdvertisement:
      interface: eth0
      enabled: true

  # Subnet allocation (Mode 2)
  # If we receive 2001:db8:1234::/56, these subnets are carved out:
  subnets:
    # LoadBalancer IPs: 2001:db8:1234:ff::/64 (last /64 in the /56)
    - name: loadbalancers
      offset: 0xff0000000000000000  # 255 in the 4th hextet
      prefixLength: 64

    # DMZ services: 2001:db8:1234:fe::/120 (256 addresses)
    - name: dmz
      offset: 0xfe00000000001000
      prefixLength: 120

  transition:
    drainPeriodMinutes: 60
    maxPrefixHistory: 2

---
# Simple RA-only Mode 1 for testing
apiVersion: dynamic-prefix.io/v1alpha1
kind: DynamicPrefix
metadata:
  name: simple-test
spec:
  acquisition:
    routerAdvertisement:
      interface: eth0
      enabled: true

  addressRanges:
    - name: default
      start: "::f000:0:0:0"
      end: "::f0ff:ffff:ffff:ffff"

  transition:
    drainPeriodMinutes: 5
    maxPrefixHistory: 1
