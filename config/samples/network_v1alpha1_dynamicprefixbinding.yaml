# Example bindings for Cilium integration
# These connect DynamicPrefix subnets to Cilium resources
---
# Bind the loadbalancers subnet to a Cilium LB-IPAM pool
apiVersion: network.reith.cloud/v1alpha1
kind: DynamicPrefixBinding
metadata:
  name: cilium-lb-pool-binding
spec:
  # Reference to the DynamicPrefix
  prefixRef:
    name: deutsche-telekom-ipv6
    subnet: loadbalancers  # Use the "loadbalancers" subnet

  # Target Cilium resource to update
  target:
    kind: CiliumLoadBalancerIPPool
    name: ipv6-vlan222-pool
    namespace: kube-system

  # How to update the target
  updateStrategy:
    # Replace: Overwrite all CIDR blocks (simple, causes brief disruption)
    # Append: Add new prefix, keep old (used during graceful transitions)
    type: Replace

---
# Bind the prefix to a CiliumCIDRGroup for network policies
# Useful for "allow traffic from my home network" rules
apiVersion: network.reith.cloud/v1alpha1
kind: DynamicPrefixBinding
metadata:
  name: home-cidrgroup-binding
spec:
  prefixRef:
    name: deutsche-telekom-ipv6
    # No subnet specified = use the full acquired prefix

  target:
    kind: CiliumCIDRGroup
    name: home-network-prefix
    # CiliumCIDRGroup is cluster-scoped, no namespace

  updateStrategy:
    type: Replace

---
# Example: Multiple pools from same prefix
# Use different subnets for different purposes
apiVersion: network.reith.cloud/v1alpha1
kind: DynamicPrefixBinding
metadata:
  name: dmz-services-binding
spec:
  prefixRef:
    name: deutsche-telekom-ipv6
    subnet: services

  target:
    kind: CiliumLoadBalancerIPPool
    name: dmz-services-pool
    namespace: kube-system

  updateStrategy:
    type: Replace

---
# Target Cilium resources that these bindings update
# (These would normally already exist in your cluster)

# The LB-IPAM pool managed by the operator
# apiVersion: cilium.io/v2alpha1
# kind: CiliumLoadBalancerIPPool
# metadata:
#   name: ipv6-vlan222-pool
#   namespace: kube-system
# spec:
#   # This CIDR will be automatically updated by the operator
#   blocks:
#     - cidr: "fd00:placeholder::/120"  # Placeholder, operator will replace
#   # Optional: Only allocate to services with this label
#   serviceSelector:
#     matchLabels:
#       io.cilium/lb-ipam: ipv6-vlan222

# The CIDRGroup for network policies
# apiVersion: cilium.io/v2
# kind: CiliumCIDRGroup
# metadata:
#   name: home-network-prefix
# spec:
#   # This will be automatically updated by the operator
#   externalCIDRs:
#     - "fd00:placeholder::/60"  # Placeholder, operator will replace

# Example network policy using the CIDRGroup
# apiVersion: cilium.io/v2
# kind: CiliumNetworkPolicy
# metadata:
#   name: allow-from-home
#   namespace: default
# spec:
#   endpointSelector:
#     matchLabels:
#       app: my-service
#   ingress:
#     - fromCIDRSet:
#         - cidrGroupRef: home-network-prefix  # References our dynamic prefix!
