# Example: Pools that reference DynamicPrefix via annotations
# The operator watches for these annotations and keeps the pools in sync.
#
# This follows the 1Password Operator pattern where target resources
# reference the source via annotations, rather than requiring a
# separate binding resource.

# =============================================================================
# Mode 1: Address Range Examples (Recommended)
# =============================================================================
# Use dynamic-prefix.io/address-range to reference an address range.
# This uses start/stop addresses for precise pool definition.

---
# Cilium LoadBalancer IP Pool using address range (Mode 1)
apiVersion: cilium.io/v2alpha1
kind: CiliumLoadBalancerIPPool
metadata:
  name: ipv6-loadbalancers
  annotations:
    # Reference to the DynamicPrefix resource
    dynamic-prefix.io/name: home-ipv6

    # Which address range from the DynamicPrefix to use
    dynamic-prefix.io/address-range: loadbalancers
spec:
  # The operator manages this - it will populate/update with start/stop addresses
  # based on the calculated range from the DynamicPrefix resource
  blocks: []

  # You can still add static configuration
  # serviceSelector:
  #   matchLabels:
  #     io.cilium/lb-ipam: ipv6

---
# Multiple pools using different address ranges
apiVersion: cilium.io/v2alpha1
kind: CiliumLoadBalancerIPPool
metadata:
  name: ipv6-metallb
  annotations:
    dynamic-prefix.io/name: multi-range
    dynamic-prefix.io/address-range: metallb
spec:
  blocks: []
  serviceSelector:
    matchLabels:
      metallb.universe.tf/address-pool: ipv6

---
apiVersion: cilium.io/v2alpha1
kind: CiliumLoadBalancerIPPool
metadata:
  name: ipv6-egress
  annotations:
    dynamic-prefix.io/name: multi-range
    dynamic-prefix.io/address-range: egress
spec:
  blocks: []
  serviceSelector:
    matchLabels:
      egress: "true"

# =============================================================================
# Mode 2: Subnet Examples (Advanced)
# =============================================================================
# Use dynamic-prefix.io/subnet to reference a subnet (CIDR-based).

---
# Cilium LoadBalancer IP Pool using subnet (Mode 2)
apiVersion: cilium.io/v2alpha1
kind: CiliumLoadBalancerIPPool
metadata:
  name: ipv6-advanced-lb
  annotations:
    dynamic-prefix.io/name: advanced-ipv6
    dynamic-prefix.io/subnet: loadbalancers
spec:
  blocks: []

---
# Cilium LoadBalancer IP Pool for DMZ services (Mode 2)
apiVersion: cilium.io/v2alpha1
kind: CiliumLoadBalancerIPPool
metadata:
  name: ipv6-dmz
  annotations:
    dynamic-prefix.io/name: advanced-ipv6
    dynamic-prefix.io/subnet: dmz
spec:
  blocks: []
  serviceSelector:
    matchLabels:
      zone: dmz

# =============================================================================
# CIDRGroup Examples (for Network Policies)
# =============================================================================
# CIDRGroups only support CIDR format, so they use the approximate CIDR
# from address ranges or exact CIDR from subnets.

---
# CiliumCIDRGroup for network policies using address range
# Note: Uses the approximate CIDR that contains the range
apiVersion: cilium.io/v2alpha1
kind: CiliumCIDRGroup
metadata:
  name: lb-network
  annotations:
    dynamic-prefix.io/name: home-ipv6
    dynamic-prefix.io/address-range: loadbalancers
spec:
  # The operator manages this
  externalCIDRs: []

---
# CiliumCIDRGroup using the full current prefix
apiVersion: cilium.io/v2alpha1
kind: CiliumCIDRGroup
metadata:
  name: home-network
  annotations:
    dynamic-prefix.io/name: home-ipv6
    # No subnet or address-range = use currentPrefix directly
spec:
  externalCIDRs: []

---
# Example network policy using the CIDRGroup
# This allows traffic from your home network, even when the prefix changes
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: allow-from-home
  namespace: default
spec:
  endpointSelector:
    matchLabels:
      app: my-service
  ingress:
    - fromCIDRSet:
        # References the operator-managed CIDRGroup
        - cidrGroupRef: home-network

# =============================================================================
# What the operator produces
# =============================================================================
# After the operator processes these, they'll look like:
#
# Mode 1 (Address Range) - uses start/stop for precise definition:
# apiVersion: cilium.io/v2alpha1
# kind: CiliumLoadBalancerIPPool
# metadata:
#   name: ipv6-loadbalancers
#   annotations:
#     dynamic-prefix.io/name: home-ipv6
#     dynamic-prefix.io/address-range: loadbalancers
#     dynamic-prefix.io/last-sync: "2026-01-23T10:00:00Z"
# spec:
#   blocks:
#     - start: "2001:db8:abcd:1:f000::"
#       stop: "2001:db8:abcd:1:ffff:ffff:ffff:ffff"
#
# Mode 2 (Subnet) - uses CIDR:
# apiVersion: cilium.io/v2alpha1
# kind: CiliumLoadBalancerIPPool
# metadata:
#   name: ipv6-advanced-lb
#   annotations:
#     dynamic-prefix.io/name: advanced-ipv6
#     dynamic-prefix.io/subnet: loadbalancers
#     dynamic-prefix.io/last-sync: "2026-01-23T10:00:00Z"
# spec:
#   blocks:
#     - cidr: "2001:db8:1234:ff::/64"
#
# When the prefix changes, the operator automatically updates the pool.
